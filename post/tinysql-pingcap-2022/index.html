<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>TinySQL 实现笔记 - Even - A super concise theme for Hugo</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="mumon"><meta name=description content="TinySQL 实现笔记 原项目：https://github.com/talent-plan/tinysql 我的实现：https://github.com"><meta name=keywords content="Hugo,theme,even"><meta name=generator content="Hugo 0.98.0 with theme even"><link rel=canonical href=http://localhost:1313/post/tinysql-pingcap-2022/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="TinySQL 实现笔记"><meta property="og:description" content="TinySQL 实现笔记 原项目：https://github.com/talent-plan/tinysql 我的实现：https://github.com"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/post/tinysql-pingcap-2022/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-03-02T00:33:55+08:00"><meta property="article:modified_time" content="2023-03-02T00:33:55+08:00"><meta itemprop=name content="TinySQL 实现笔记"><meta itemprop=description content="TinySQL 实现笔记 原项目：https://github.com/talent-plan/tinysql 我的实现：https://github.com"><meta itemprop=datePublished content="2023-03-02T00:33:55+08:00"><meta itemprop=dateModified content="2023-03-02T00:33:55+08:00"><meta itemprop=wordCount content="1773"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="TinySQL 实现笔记"><meta name=twitter:description content="TinySQL 实现笔记 原项目：https://github.com/talent-plan/tinysql 我的实现：https://github.com"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>Even</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>Even</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>TinySQL 实现笔记</h1><div class=post-meta><span class=post-time>2023-03-02</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#proj-1>proj 1</a><ul><li><a href=#part-1>part 1</a><ul><li><a href=#sql-practice>sql practice</a></li></ul></li><li><a href=#part-2>part 2</a><ul><li><a href=#table-codec>Table Codec</a></li></ul></li></ul></li><li><a href=#proj-2>proj 2</a></li><li><a href=#proj-3>proj 3</a></li><li><a href=#proj-4>proj 4</a><ul><li><a href=#part-1-1>part 1</a><ul><li><a href=#system-r>System R</a></li></ul></li><li><a href=#part-2-1>part 2</a><ul><li><a href=#cm-sketch>CM Sketch</a></li><li><a href=#join-reorder>Join Reorder</a></li><li><a href=#access-path-selection>Access Path Selection</a></li></ul></li></ul></li><li><a href=#proj-5>proj 5</a></li><li><a href=#proj-6>proj 6</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div><div class=post-content><p>TinySQL 实现笔记</p><p>原项目：<a href=https://github.com/talent-plan/tinysql>https://github.com/talent-plan/tinysql</a></p><p>我的实现：<a href=https://github.com/wzymumon/tinysql>https://github.com/wzymumon/tinysql</a></p><h1 id=proj-1>proj 1</h1><h2 id=part-1>part 1</h2><h3 id=sql-practice>sql practice</h3><p>按照 <a href=https://tour.pingcap.com/>A Tour of TiDB</a> 的教程熟悉一下 TiDB 和基础的 sql 语法。然后完成 HackerRank 上的 sql 题目。</p><h2 id=part-2>part 2</h2><h3 id=table-codec>Table Codec</h3><p>tidb 的底层存储使用的是 tikv，本节主要介绍 tinysql 上的数据是如何映射到 kv 上的。</p><p>本节需要我们补充 <code>DecodeRecordKey</code> 和 <code>DecodeIndexKeyPrefix</code>。这两个函数用来解码行记录与索引中的 Key ，得到 tableID、handle、indexID 等信息。解码时可以用切片来取。行记录的 key 为<code>t&lt;tbleID>_r&lt;handle></code>，索引的 key 为 <code>t&lt;tableID>_i&lt;indexID>&lt;indexColumnsValue></code>。</p><h1 id=proj-2>proj 2</h1><p>Parser 主要的功能是将 SQL 语句文本按照预先定义的 SQL 语法规则进行解析，并将其转换为抽象语法树(Abstract Syntax Tree, AST)。在<code>tinysql</code>中，语法分析对应的 SQL 语法文件是<code>parser.y</code>，goyacc 会根据这个文件生成对应的 SQL 语法解析器。</p><p>proj2中需要我们补充<code>parser.y</code>中关于<code>JoinTable</code>部分的语法。可以参考 Mysql 和 Tidb 中 <a href=https://dev.mysql.com/doc/refman/8.0/en/>joined_table</a> 的实现。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Plain data-lang=Plain><span class=line><span class=cl>joined_table: {
</span></span><span class=line><span class=cl>    table_reference {[INNER | CROSS] JOIN | STRAIGHT_JOIN} table_factor [join_specification]
</span></span><span class=line><span class=cl>  | table_reference {LEFT|RIGHT} [OUTER] JOIN table_reference join_specification
</span></span><span class=line><span class=cl>  | table_reference NATURAL [INNER | {LEFT|RIGHT} [OUTER]] JOIN table_factor
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><blockquote><ol><li><a href=http://dinosaur.compilertools.net/>Lex & Yacc</a></li><li><a href=https://pingcap.com/zh/blog/tidb-source-code-reading-5>https://pingcap.com/zh/blog/tidb-source-code-reading-5</a></li><li><a href=https://github.com/cznic/goyacc>https://github.com/cznic/goyacc</a></li><li><a href=http://dinosaur.compilertools.net/>http://dinosaur.compilertools.net/</a></li><li><a href=https://dev.mysql.com/doc/refman/8.0/en/>https://dev.mysql.com/doc/refman/8.0/en/</a></li></ol></blockquote><h1 id=proj-3>proj 3</h1><p>该部分主要关注 Schema Change 和 ddl 执行流程。<del>但该部分文档中的 <a href=https://github.com/pingcap-incubator/tinysql/blob/course/ddl/ddl.go#L182>d.addDDLJob(ctx, job)</a> 指向的位置貌似不太对？</del>（已修复<a href=https://github.com/talent-plan/tinysql/pull/143>#143</a>）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=c1>// column has not-null flag and it hasn&#39;t the default value.
</span></span></span><span class=line><span class=cl><span class=c1>// If the state of StateWriteOnly can be rollbacked, we need to consider the origin default Value.
</span></span></span><span class=line><span class=cl><span class=c1>// https://github.com/pingcap/tidb/blob/a5ec60fceb54fbb6a440f8f7cb6dba5634304652/ddl/column.go#L207
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=nx>colInfo</span><span class=p>.</span><span class=nx>OriginDefaultValue</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>mysql</span><span class=p>.</span><span class=nf>HasNotNullFlag</span><span class=p>(</span><span class=nx>colInfo</span><span class=p>.</span><span class=nx>Flag</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>originDefVal</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>generateOriginDefaultValue</span><span class=p>(</span><span class=nx>colInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>ver</span><span class=p>,</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>Trace</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>colInfo</span><span class=p>.</span><span class=nx>OriginDefaultValue</span> <span class=p>=</span> <span class=nx>originDefVal</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><ol><li><a href=https://github.com/ngaut/builddatabase/blob/master/f1/schema-change.md>https://github.com/ngaut/builddatabase/blob/master/f1/schema-change.md</a></li><li><a href=https://github.com/ngaut/builddatabase/blob/master/f1/schema-change-implement.md>https://github.com/ngaut/builddatabase/blob/master/f1/schema-change-implement.md</a></li></ol></blockquote><h1 id=proj-4>proj 4</h1><h2 id=part-1-1>part 1</h2><h3 id=system-r>System R</h3><p>该部分需要实现 <code>LogicalAggregation</code> 的谓词下推。先通过 group by 的列找到可以下推的 condtion，然后保留其中有用的列，最后将选出来的谓词下推即可。</p><p>这里要实现从 sel->agg->x 到 agg->sel->x 或者 sel->agg->sel->x 的变换。当 sel 中的condition 都存在于 agg 中就可以完全下推到 agg 。对于sel 中的 conditions 而言，如果 condition 中的 columns 都存在于 agg 的 group by 的 columns 当中，则该 condition 可以下推。不满足的话，该condition就不能下推，就保留在原位置。</p><h2 id=part-2-1>part 2</h2><h3 id=cm-sketch>CM Sketch</h3><p>实现 CM Sketch 算法，可以参考<a href=https://pingcap.com/blog-cn/tidb-source-code-reading-12/>TiDB 源码阅读系列文章（十二）统计信息（上）</a>，实现 insert value 和 query。</p><p><code>insertBytesByCount</code>函数需要实现 sketch 中的 hash 算法。<code>queryHashValue</code> 函数用于进行等值查询估算。由于 Count-Min Sketch 估计的结果总是不小于实际值，因此在 TiDB 中，使用选择了文献 <a href=http://webdocs.cs.ualberta.ca/~drafiei/papers/cmm.pdf>New estimation algorithms for streaming data: Count-min can do more </a>中提出的 Count-Mean-Min Sketch算法，使用 <code>(N - CM[i, j]) / (w-1)</code>（N 是个数 c.count，w为宽度 c.depth）作为噪音，因此用 <code>CM[i,j] - noise</code>作为对应行的估计值，然后取所有行的估计值的中位数作为最后的估计值。</p><h3 id=join-reorder>Join Reorder</h3><p>本节需要实现一个基于 DP 的 Join Reorder 算法，通过动态规划获取 Join 的最优排序，需要实现的函数位置: planner/core/rule_join_reorder_dp.go 。实现时挺复杂的，DP是在图上进行的，需要构建一张 Join 图。然后针对不同节点进行广度遍历，获取 Join Group，再对 Join Group 进行动态规划。</p><p><img src=https://mario-1302125365.cos.ap-guangzhou.myqcloud.com/blog/202303020040988.png alt=img></p><p>该算法具体流程如下：</p><ul><li>通过邻接矩阵的形式构建 Join graph。</li><li>记录 EqEdge和 NonEqEdge，Eqedge 作为 Join graph 的边，用来计算 cost，NonEqEdge 不参与 Join Reorder。</li><li>选择一个未访问过的节点开始广度优先遍历，获得一个 Join Group。</li><li>对 Join group 进行动态规划，获取最优的 Join Tree。</li><li>转移方程是 <code>f[group] = min{join{f[sub], f[group ^ sub])}</code>。</li><li>当所有节点均访问过后，将所有的 Join 方案合在一起进行 Buzy Join，得到最终的 Join 方案。</li></ul><p>其实现难点在于需要预先构建 Join Graph 和使用二进制来表示参与 Join 的节点内容。11（二进制表示为 1011）表示当前的 Join Group 包含了第 3 号节点，第 1 号节点和第 0 号节点（节点从 0 开始计数）。f[11] 来表示包含了节点 <code>3, 1, 0</code> 的最优的 Join Tree。转移方程则是 <code>f[group] = min{join{f[sub], f[group ^ sub])}</code> 这里 <code>sub</code> 是 <code>group</code> 二进制表示下的任意子集。</p><h3 id=access-path-selection>Access Path Selection</h3><p>本节需要实现 skyline pruning 算法，compareCandidates 是 skyline pruning 的核心部分，从三个维度来比较 candidate，在比较时，如果 x 在所有维度上都不比 y 差，且存在一个维度 x 优于 y，则 x 优于 y。</p><ol><li>所涉猎的列是否可以被另一个索引覆盖：比较两个 candidate 的 col，覆盖范围更大的 candidate 更优。</li><li>有没有 ORDER BY property：比较两个 candidate 是否 match physical property，match 的那个更优。</li><li>是否需要回表：比较两个 candidate 是否只需要扫描一次，只扫描一次的那个更优。</li></ol><h1 id=proj-5>proj 5</h1><p>WIP</p><h1 id=proj-6>proj 6</h1><p>WIP</p><h1 id=参考>参考</h1></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>mumon</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2023-03-02</span></p></div><footer class=post-footer><nav class=post-nav><a class=next href=/post/udf-for-milvus/><span class="next-text nav-default">Udf for Milvus - OSPP 2022</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=wzyubill1104@email.com class="iconfont icon-email" title=email></a>
<a href=https://github.com/wzymumon class="iconfont icon-github" title=github></a>
<a href=http://localhost:1313/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2022 -
2023<span class=heart><i class="iconfont icon-heart"></i></span><span>mumon</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js></script></body></html>